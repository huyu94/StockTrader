# è‚¡ç¥¨åˆ†æç³»ç»Ÿ

## é¡¹ç›®æ¦‚è¿°

åŸºäºTushareæ¥å£çš„è‚¡ç¥¨åˆ†æç³»ç»Ÿï¼Œå®ç°è‚¡ç¥¨æ•°æ®è·å–ã€æŠ€æœ¯æŒ‡æ ‡è®¡ç®—ã€ç­–ç•¥ç­›é€‰å’Œæ•°æ®å¯è§†åŒ–åŠŸèƒ½ã€‚

æœ¬é¡¹ç›®é‡‡ç”¨**åŒæ¶æ„è®¾è®¡**ï¼š
1. **ä¼ ç»Ÿæ¶æ„**ï¼ˆ`src/`ï¼‰ï¼šProvider â†’ Fetcher â†’ Storage â†’ Manager åˆ†å±‚æ¶æ„ï¼Œç”¨äºå¿«é€Ÿæ•°æ®è·å–
2. **ETL Pipeline æ¶æ„**ï¼ˆ`core/`ï¼‰ï¼šCollector â†’ Transformer â†’ Loader çš„ ETL æµæ°´çº¿æ¶æ„ï¼Œç”¨äºæ ‡å‡†åŒ–æ•°æ®å¤„ç†æµç¨‹

---

## ä¸€ã€ETL Pipeline æ¶æ„ï¼ˆæ ¸å¿ƒæ¶æ„ï¼‰

### 1.1 æ¶æ„æ¦‚è¿°

ç³»ç»Ÿé‡‡ç”¨ **ETL Pipeline æ¶æ„**ï¼Œå°†æ•°æ®å¤„ç†æµç¨‹åˆ†ä¸ºä¸‰ä¸ªç‹¬ç«‹é˜¶æ®µï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Collector  â”‚ --> â”‚ Transformer  â”‚ --> â”‚   Loader   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                    â†“                    â†“
   æ•°æ®é‡‡é›†             æ•°æ®æ¸…æ´—è½¬æ¢          æ•°æ®å…¥åº“
```

### 1.2 æ ¸å¿ƒç»„ä»¶

#### Collectorsï¼ˆæ•°æ®é‡‡é›†å±‚ï¼‰

**èŒè´£**ï¼šä»å¤–éƒ¨æ•°æ®æºé‡‡é›†åŸå§‹æ•°æ®

- âœ… `BaseCollector` - é‡‡é›†å™¨åŸºç±»
- âœ… `DailyKlineCollector` - æ—¥Kçº¿æ•°æ®é‡‡é›†
- âœ… `AdjFactorCollector` - å¤æƒå› å­é‡‡é›†
- âœ… `BasicInfoCollector` - è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯é‡‡é›†
- âœ… `TradeCalendarCollector` - äº¤æ˜“æ—¥å†é‡‡é›†
- âœ… `ExDateCollector` - é™¤æƒé™¤æ¯æ—¥é‡‡é›†ï¼ˆå†…éƒ¨ç»„ä»¶ï¼‰
- âœ… `IntradayKlineCollector` - åˆ†æ—¶Kçº¿æ•°æ®é‡‡é›†ï¼ˆä½¿ç”¨ akshare å®æ—¶è¡Œæƒ…æ¥å£ï¼‰

**ç‰¹æ€§**ï¼š
- æ”¯æŒå¤šæ•°æ®æºåˆ‡æ¢ï¼ˆTushareã€Akshareç­‰ï¼‰
- å†…ç½®é‡è¯•æœºåˆ¶
- å‚æ•°éªŒè¯
- ç»Ÿä¸€çš„æ•°æ®è¿”å›æ ¼å¼ï¼ˆDataFrameï¼‰
- Collector åªè´Ÿè´£è·å–åŸå§‹æ•°æ®ï¼Œä¸åšæ•°æ®è½¬æ¢

#### Transformersï¼ˆæ•°æ®è½¬æ¢å±‚ï¼‰

**èŒè´£**ï¼šæ•°æ®æ¸…æ´—ã€æ ‡å‡†åŒ–ã€è¡ç”ŸæŒ‡æ ‡è®¡ç®—

- âœ… `BaseTransformer` - è½¬æ¢å™¨åŸºç±»
- âœ… `DailyKlineTransformer` - Kçº¿æ•°æ®æ¸…æ´—ã€æ ‡å‡†åŒ–
- âœ… `AdjFactorTransformer` - å¤æƒå› å­å¤„ç†
- âœ… `BasicInfoTransformer` - åŸºæœ¬ä¿¡æ¯å¤„ç†
- âœ… `TradeCalendarTransformer` - äº¤æ˜“æ—¥å†å¤„ç†
- âœ… `IntradayKlineTransformer` - åˆ†æ—¶Kçº¿æ•°æ®è½¬æ¢ï¼ˆæ”¯æŒ akshare æ•°æ®æ ¼å¼æ ‡å‡†åŒ–ï¼‰

**ä¸»è¦åŠŸèƒ½**ï¼š
- å­—æ®µé‡å‘½åå’Œæ˜ å°„
- æ•°æ®ç±»å‹è½¬æ¢
- å¼‚å¸¸å€¼å¤„ç†
- ç¼ºå¤±å€¼å¤„ç†
- æ•°æ®è´¨é‡éªŒè¯

#### Loadersï¼ˆæ•°æ®åŠ è½½å±‚ï¼‰

**èŒè´£**ï¼šå°†å¤„ç†åçš„æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“

- âœ… `BaseLoader` - åŠ è½½å™¨åŸºç±»
- âœ… `DailyKlineLoader` - Kçº¿å…¥åº“é€»è¾‘
- âœ… `AdjFactorLoader` - å¤æƒå› å­å…¥åº“é€»è¾‘
- âœ… `BasicInfoLoader` - åŸºæœ¬ä¿¡æ¯å…¥åº“é€»è¾‘
- âœ… `TradeCalendarLoader` - äº¤æ˜“æ—¥å†å…¥åº“é€»è¾‘
- âœ… `IntradayKlineLoader` - åˆ†æ—¶Kçº¿æ•°æ®å…¥åº“é€»è¾‘

**åŠ è½½ç­–ç•¥**ï¼š
- `append`ï¼šè¿½åŠ æ•°æ®ï¼ˆä½¿ç”¨ INSERT IGNOREï¼‰
- `replace`ï¼šæ›¿æ¢æ•°æ®ï¼ˆå…ˆåˆ é™¤å†æ’å…¥ï¼‰
- `upsert`ï¼šå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥ï¼ˆä½¿ç”¨ INSERT ... ON DUPLICATE KEY UPDATEï¼‰

**ç‰¹æ€§**ï¼š
- æ”¯æŒæ‰¹é‡åŠ è½½ï¼ˆå¯é…ç½®æ‰¹é‡å¤§å°ï¼‰
- æ”¯æŒ MySQL æ•°æ®åº“ï¼ˆé€šè¿‡ SQLAlchemy ORMï¼‰
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œäº‹åŠ¡ç®¡ç†
- æ•°æ®éªŒè¯ï¼ˆåŠ è½½å‰éªŒè¯å¿…éœ€åˆ—ï¼‰

#### Modelsï¼ˆæ•°æ®æ¨¡å‹ï¼‰

**ä¸šåŠ¡æ•°æ®æ¨¡å‹**ï¼š
- âœ… `DailyKline` - æ—¥Kçº¿æ•°æ®æ¨¡å‹
- âœ… `AdjFactor` - å¤æƒå› å­æ•°æ®æ¨¡å‹
- âœ… `StockBasicInfo` - è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯æ¨¡å‹
- âœ… `TradeCalendar` - äº¤æ˜“æ—¥å†æ¨¡å‹
- âœ… `IntradayKline` - åˆ†æ—¶Kçº¿æ•°æ®æ¨¡å‹

**ORM æ¨¡å‹**ï¼š
- âœ… `DailyKlineORM` - æ—¥Kçº¿ ORM æ¨¡å‹
- âœ… `AdjFactorORM` - å¤æƒå› å­ ORM æ¨¡å‹
- âœ… `BasicInfoORM` - åŸºæœ¬ä¿¡æ¯ ORM æ¨¡å‹
- âœ… `TradeCalendarORM` - äº¤æ˜“æ—¥å† ORM æ¨¡å‹
- âœ… `IntradayKlineORM` - åˆ†æ—¶Kçº¿ ORM æ¨¡å‹

æ‰€æœ‰ ORM æ¨¡å‹ç»Ÿä¸€åœ¨ `core/models/orm.py` ä¸­å®šä¹‰ã€‚

#### Pipelinesï¼ˆæµæ°´çº¿ç¼–æ’å±‚ï¼‰

**èŒè´£**ï¼šç¼–æ’ ETL æµç¨‹

- âœ… `BasePipeline` - Pipeline åŸºç±»ï¼ˆæ¡†æ¶å·²æ­å»ºï¼‰
- â³ `DailyPipeline` - æ¯æ—¥æ›´æ–°æµæ°´çº¿ï¼ˆå¾…å®ç°ï¼‰
- â³ `HistoryPipeline` - å†å²æ•°æ®è¡¥å…¨æµæ°´çº¿ï¼ˆå¾…å®ç°ï¼‰
- â³ `RealtimePipeline` - å®æ—¶æ•°æ®æµæ°´çº¿ï¼ˆå¾…å®ç°ï¼‰

#### Orchestratorï¼ˆè°ƒåº¦ç¼–æ’å±‚ï¼‰

**èŒè´£**ï¼šä»»åŠ¡è°ƒåº¦ã€ä¾èµ–ç®¡ç†ã€ç›‘æ§å‘Šè­¦

- â³ `TaskScheduler` - ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆæ¡†æ¶å·²æ­å»ºï¼Œå¾…å®ç°ï¼‰
- â³ `DependencyManager` - ä»»åŠ¡ä¾èµ–ç®¡ç†ï¼ˆæ¡†æ¶å·²æ­å»ºï¼Œå¾…å®ç°ï¼‰
- â³ `TaskMonitor` - ç›‘æ§å’Œå‘Šè­¦ï¼ˆæ¡†æ¶å·²æ­å»ºï¼Œå¾…å®ç°ï¼‰

#### Commonï¼ˆå…¬å…±ç»„ä»¶ï¼‰

- âœ… `exceptions.py` - å¼‚å¸¸å®šä¹‰ï¼ˆå·²å®Œæˆï¼‰
- â³ `validators.py` - æ•°æ®éªŒè¯ï¼ˆæ¡†æ¶å·²æ­å»ºï¼Œå¾…å®ç°ï¼‰
- â³ `utils.py` - å·¥å…·å‡½æ•°ï¼ˆæ¡†æ¶å·²æ­å»ºï¼Œå¾…å®ç°ï¼‰

### 1.3 ç›®å½•ç»“æ„

```
core/
â”œâ”€â”€ collectors/              # æ•°æ®é‡‡é›†å±‚ âœ…
â”‚   â”œâ”€â”€ base.py
â”‚   â”œâ”€â”€ daily_kline.py
â”‚   â”œâ”€â”€ adj_factor.py
â”‚   â”œâ”€â”€ ex_date.py
â”‚   â”œâ”€â”€ basic_info.py
â”‚   â”œâ”€â”€ trade_calendar.py
â”‚   â””â”€â”€ intraday_kline.py   # åˆ†æ—¶Kçº¿æ•°æ®é‡‡é›†
â”‚
â”œâ”€â”€ transformers/            # æ•°æ®è½¬æ¢å±‚ âœ…
â”‚   â”œâ”€â”€ base.py
â”‚   â”œâ”€â”€ daily_kline.py
â”‚   â”œâ”€â”€ adj_factor.py
â”‚   â”œâ”€â”€ basic_info.py
â”‚   â”œâ”€â”€ trade_calendar.py
â”‚   â””â”€â”€ intraday_kline.py   # åˆ†æ—¶Kçº¿æ•°æ®è½¬æ¢
â”‚
â”œâ”€â”€ loaders/                 # æ•°æ®åŠ è½½å±‚ âœ…
â”‚   â”œâ”€â”€ base.py
â”‚   â”œâ”€â”€ daily_kline.py
â”‚   â”œâ”€â”€ adj_factor.py
â”‚   â”œâ”€â”€ basic_info.py
â”‚   â”œâ”€â”€ trade_calendar.py
â”‚   â””â”€â”€ intraday_kline.py   # åˆ†æ—¶Kçº¿æ•°æ®åŠ è½½
â”‚
â”œâ”€â”€ calculators/             # è®¡ç®—å™¨æ¨¡å— âœ…
â”‚   â”œâ”€â”€ qfq_calculator.py   # å‰å¤æƒè®¡ç®—å™¨
â”‚   â””â”€â”€ aggregator.py       # èšåˆè®¡ç®—å™¨
â”‚
â”œâ”€â”€ pipelines/               # æµæ°´çº¿ç¼–æ’å±‚ â³
â”‚   â”œâ”€â”€ base.py
â”‚   â”œâ”€â”€ daily_pipeline.py
â”‚   â”œâ”€â”€ history_pipeline.py
â”‚   â””â”€â”€ realtime_pipeline.py
â”‚
â”œâ”€â”€ models/                  # æ•°æ®æ¨¡å‹ âœ…
â”‚   â”œâ”€â”€ daily_kline.py      # ä¸šåŠ¡æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ adj_factor.py
â”‚   â”œâ”€â”€ stock_basic_info.py
â”‚   â”œâ”€â”€ calendar.py
â”‚   â”œâ”€â”€ intraday_kline.py   # åˆ†æ—¶Kçº¿ä¸šåŠ¡æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ orm.py              # ORM æ¨¡å‹
â”‚
â”œâ”€â”€ orchestrator/            # è°ƒåº¦ç¼–æ’å±‚ â³
â”‚   â”œâ”€â”€ scheduler.py
â”‚   â”œâ”€â”€ dependency.py
â”‚   â””â”€â”€ monitor.py
â”‚
â”œâ”€â”€ config/                  # é…ç½®ç®¡ç† ğŸ“‹
â”‚   â”œâ”€â”€ pipelines/          # Pipelineé…ç½®ï¼ˆç¤ºä¾‹æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ schedules.yaml.example
â”‚   â”œâ”€â”€ sources.yaml.example
â”‚   â””â”€â”€ database.yaml.example
â”‚
â””â”€â”€ common/                  # å…¬å…±ç»„ä»¶ â³
    â”œâ”€â”€ exceptions.py       # âœ… å·²å®Œæˆ
    â”œâ”€â”€ validators.py       # â³ å¾…å®ç°
    â””â”€â”€ utils.py            # â³ å¾…å®ç°
```

### 1.4 é¡¹ç›®è¿›åº¦

#### âœ… å·²å®Œæˆï¼ˆçº¦ 85%ï¼‰

1. **æ•°æ®é‡‡é›†å±‚ï¼ˆCollectorsï¼‰** - 100%
   - æ‰€æœ‰é‡‡é›†å™¨å·²å®ç°
   - æ”¯æŒ Tushare æ•°æ®æº
   - æ”¯æŒ Akshare æ•°æ®æºï¼ˆå®æ—¶è¡Œæƒ…ï¼‰
   - åŒ…å«é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
   - âœ… æ–°å¢ï¼š`IntradayKlineCollector` - åˆ†æ—¶æ•°æ®é‡‡é›†å™¨

2. **æ•°æ®è½¬æ¢å±‚ï¼ˆTransformersï¼‰** - 100%
   - æ‰€æœ‰è½¬æ¢å™¨å·²å®ç°
   - æ”¯æŒæ•°æ®æ¸…æ´—ã€æ ‡å‡†åŒ–ã€éªŒè¯
   - âœ… æ–°å¢ï¼š`IntradayKlineTransformer` - åˆ†æ—¶æ•°æ®è½¬æ¢å™¨ï¼ˆæ”¯æŒ akshare æ•°æ®æ ¼å¼æ ‡å‡†åŒ–ï¼‰

3. **æ•°æ®åŠ è½½å±‚ï¼ˆLoadersï¼‰** - 100%
   - æ‰€æœ‰åŠ è½½å™¨å·²å®ç°
   - æ”¯æŒä¸‰ç§åŠ è½½ç­–ç•¥ï¼ˆappend/replace/upsertï¼‰
   - æ”¯æŒ MySQL æ•°æ®åº“
   - æ”¯æŒæ‰¹é‡åŠ è½½
   - âœ… æ–°å¢ï¼š`IntradayKlineLoader` - åˆ†æ—¶æ•°æ®åŠ è½½å™¨

4. **æ•°æ®æ¨¡å‹ï¼ˆModelsï¼‰** - 100%
   - ä¸šåŠ¡æ•°æ®æ¨¡å‹å·²å®ç°
   - ORM æ¨¡å‹å·²å®ç°å¹¶ç»Ÿä¸€ç®¡ç†
   - âœ… æ–°å¢ï¼š`IntradayKline` - åˆ†æ—¶æ•°æ®ä¸šåŠ¡æ¨¡å‹
   - âœ… æ–°å¢ï¼š`IntradayKlineORM` - åˆ†æ—¶æ•°æ® ORM æ¨¡å‹

5. **è®¡ç®—å™¨æ¨¡å—ï¼ˆCalculatorsï¼‰** - 100% âœ…
   - âœ… `QFQCalculator` - å‰å¤æƒè®¡ç®—å™¨
   - âœ… `Aggregator` - èšåˆè®¡ç®—å™¨ï¼ˆåˆ†æ—¶æ•°æ®èšåˆä¸ºæ—¥Kçº¿ï¼‰

6. **åˆ†æ—¶æ•°æ®æ¨¡å—ï¼ˆIntradayï¼‰** - 100% âœ…
   - âœ… åˆ†æ—¶æ•°æ®é‡‡é›†ï¼ˆä½¿ç”¨ akshare å®æ—¶è¡Œæƒ…æ¥å£ï¼‰
   - âœ… åˆ†æ—¶æ•°æ®è½¬æ¢ï¼ˆæ ‡å‡†åŒ– akshare æ•°æ®æ ¼å¼ï¼‰
   - âœ… åˆ†æ—¶æ•°æ®åŠ è½½ï¼ˆæ”¯æŒ MySQL å­˜å‚¨ï¼‰
   - âœ… åˆ†æ—¶æ•°æ®æ¨¡å‹ï¼ˆä¸šåŠ¡æ¨¡å‹å’Œ ORM æ¨¡å‹ï¼‰

7. **å…¬å…±ç»„ä»¶ï¼ˆCommonï¼‰** - 50%
   - å¼‚å¸¸å®šä¹‰å·²å®Œæˆ
   - éªŒè¯å™¨å’Œå·¥å…·å‡½æ•°å¾…å®ç°

#### â³ å¾…å®ç°ï¼ˆçº¦ 15%ï¼‰

1. **æµæ°´çº¿ç¼–æ’å±‚ï¼ˆPipelinesï¼‰** - 0%
   - æ¡†æ¶å·²æ­å»º
   - éœ€è¦å®ç°å…·ä½“çš„ ETL æµç¨‹ç¼–æ’
   - éœ€è¦å®ç°åˆ†æ—¶æ•°æ®æµæ°´çº¿

2. **è°ƒåº¦ç¼–æ’å±‚ï¼ˆOrchestratorï¼‰** - 0%
   - æ¡†æ¶å·²æ­å»º
   - éœ€è¦å®ç°ä»»åŠ¡è°ƒåº¦ã€ä¾èµ–ç®¡ç†ã€ç›‘æ§å‘Šè­¦

3. **é…ç½®ç®¡ç†** - 0%
   - ç¤ºä¾‹é…ç½®æ–‡ä»¶å·²æä¾›
   - éœ€è¦å®ç°é…ç½®åŠ è½½å’Œè§£æ

4. **å·¥å…·å‡½æ•°** - 0%
   - éœ€è¦å®ç° DataFrame åˆå¹¶ã€åˆ†å—ç­‰å·¥å…·å‡½æ•°

### 1.5 ä½¿ç”¨ç¤ºä¾‹

#### åŸºæœ¬ä½¿ç”¨

```python
from core.loaders.daily_kline import DailyKlineLoader
from core.transformers.daily_kline import DailyKlineTransformer
from core.collectors.daily_kline import DailyKlineCollector

# åˆ›å»ºç»„ä»¶
collector = DailyKlineCollector(config)
transformer = DailyKlineTransformer(config)
loader = DailyKlineLoader(config)

# æ‰§è¡Œ ETL æµç¨‹
raw_data = collector.collect(params)
clean_data = transformer.transform(raw_data)
loader.load(clean_data)
```

#### é…ç½®ç¤ºä¾‹

```yaml
# config/pipelines/daily_kline.yaml
daily_kline:
  collector:
    source: tushare
    token: ${TUSHARE_TOKEN}
    retry_times: 3
    
  transformer:
    transform_rules:
      remove_halted: true
      validate_ohlc: true
      
  loader:
    table: daily_kline
    load_strategy: upsert
    upsert_keys: ['ts_code', 'trade_date']
    batch_size: 1000
```

---

## äºŒã€ä¼ ç»Ÿæ¶æ„ï¼ˆå…¼å®¹æ¶æ„ï¼‰

### 2.1 æ¶æ„æ¦‚è§ˆ

ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä»åº•å±‚åˆ°é¡¶å±‚åˆ†ä¸ºï¼š**Providerå±‚** â†’ **Fetcherå±‚** â†’ **Storageå±‚** â†’ **Managerå±‚**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Manager (ç»Ÿä¸€ç®¡ç†å™¨)                     â”‚
â”‚  - åè°ƒæ•°æ®è·å–æµç¨‹                                           â”‚
â”‚  - ç®¡ç†çº¿ç¨‹æ± ï¼ˆIOçº¿ç¨‹æ± ã€ä»»åŠ¡çº¿ç¨‹æ± ï¼‰                          â”‚
â”‚  - æ™ºèƒ½æ›´æ–°ç­–ç•¥ï¼ˆå…¨é‡æ›´æ–°/å¢é‡æ›´æ–°ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Fetcher (æ•°æ®è·å–å±‚)                       â”‚
â”‚  - DailyKlineFetcher: æ—¥çº¿è¡Œæƒ…è·å–                           â”‚
â”‚  - BasicInfoFetcher: è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯è·å–                         â”‚
â”‚  - CalendarFetcher: äº¤æ˜“æ—¥å†è·å–                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Provider (APIæ¥å£å±‚)                       â”‚
â”‚  - TushareProvider: Tushare APIå°è£…                          â”‚
â”‚    â€¢ å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿APIè°ƒç”¨ä¸²è¡Œ                                â”‚
â”‚    â€¢ ä½¿ç”¨é”æœºåˆ¶é¿å…IPè¶…é™                                     â”‚
â”‚    â€¢ æ”¯æŒ pro_bar APIï¼ˆå¿«é€Ÿæ‰¹é‡è·å–ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Storage (æ•°æ®å­˜å‚¨å±‚)                        â”‚
â”‚  - DailyKlineStorageMySQL: æ—¥çº¿æ•°æ®MySQLå­˜å‚¨                 â”‚
â”‚  - BasicInfoStorageMySQL: åŸºæœ¬ä¿¡æ¯MySQLå­˜å‚¨                    â”‚
â”‚  - CalendarStorageMySQL: äº¤æ˜“æ—¥å†MySQLå­˜å‚¨                   â”‚
â”‚    â€¢ ç»Ÿä¸€ä½¿ç”¨MySQLæ•°æ®åº“ï¼Œæ”¯æŒè¿æ¥æ±                           â”‚
â”‚    â€¢ æ”¯æŒæ‰¹é‡å†™å…¥å’ŒUPSERTæ“ä½œ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶è¯¦è§£

#### 1. Providerå±‚ (`src/providers/`)

**TushareProvider** - Tushare APIå°è£…ç±»

- **å•ä¾‹æ¨¡å¼**ï¼šç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªAPIå®ä¾‹
- **ä¸²è¡Œè°ƒç”¨**ï¼šä½¿ç”¨ `threading.Lock` ç¡®ä¿æ‰€æœ‰APIè°ƒç”¨å®Œå…¨ä¸²è¡Œï¼Œé¿å…IPè¶…é™
- **æ€§èƒ½ä¼˜åŒ–**ï¼š
  - è®¾ç½® `NO_PROXY` ç¯å¢ƒå˜é‡ï¼Œç»•è¿‡ç³»ç»Ÿä»£ç†æé«˜é€Ÿåº¦
  - ä½¿ç”¨ `pro_bar` APIï¼Œä¸€æ¬¡è°ƒç”¨è·å–å•åªè‚¡ç¥¨å…¨éƒ¨å†å²æ•°æ®
  - æ”¯æŒ `factors` å‚æ•°ï¼ŒåŒæ—¶è·å–å¤æƒå› å­

**å…³é”®æ–¹æ³•**ï¼š
- `pro_bar()`: ä½¿ç”¨ pro_bar API è·å–Kçº¿æ•°æ®ï¼ˆæ¨èï¼Œæ›´å¿«ï¼‰
- `query()`: é€šç”¨æŸ¥è¯¢æ¥å£
- `daily()`: ä½¿ç”¨ daily API è·å–æ—¥çº¿æ•°æ®ï¼ˆç”¨äºæŒ‰æ—¥æœŸæ‰¹é‡è·å–ï¼‰

#### 2. Fetcherå±‚ (`src/fetchers/`)

**DailyKlineFetcher** - æ—¥çº¿è¡Œæƒ…è·å–å™¨

- `fetch_one()`: è·å–å•åªè‚¡ç¥¨çš„æ—¥çº¿æ•°æ®
  - ä½¿ç”¨ `pro_bar` APIï¼Œä¸€æ¬¡è·å–å…¨éƒ¨å†å²
  - è‡ªåŠ¨è·å–å¤æƒå› å­ï¼ˆ`factors="tor"`ï¼‰
  - ç»Ÿä¸€åˆ—åå¤„ç†ï¼ˆ`factor` â†’ `adj_factor`ï¼‰

- `fetch_daily_by_date()`: æŒ‰æ—¥æœŸè·å–å…¨å¸‚åœºæ•°æ®
  - ç”¨äºå¢é‡æ›´æ–°åœºæ™¯
  - å½“æŸä¸ªäº¤æ˜“æ—¥ç¼ºå¤±æ•°æ®è¾ƒå¤šæ—¶ä½¿ç”¨
  - ä½¿ç”¨ `daily` APIï¼ˆpro_barä¸æ”¯æŒæŒ‰æ—¥æœŸè·å–å…¨å¸‚åœºæ•°æ®ï¼‰

**å…¶ä»–Fetcher**ï¼š
- `BasicInfoFetcher`: è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
- `CalendarFetcher`: è·å–äº¤æ˜“æ—¥å†
- `AdjFactorFetcher`: å¤æƒå› å­è·å–ï¼ˆå·²å¼ƒç”¨ï¼Œç°åŒ…å«åœ¨æ—¥çº¿æ•°æ®ä¸­ï¼‰

#### 3. Storageå±‚ (`src/storage/`)

**MySQLå­˜å‚¨æ¶æ„**

æ‰€æœ‰æ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨ MySQL æ•°æ®åº“ä¸­ï¼ŒåŒ…å«ä»¥ä¸‹è¡¨ï¼š

- `daily_kline`: æ—¥çº¿è¡Œæƒ…æ•°æ®ï¼ˆåŒ…å«å¤æƒå› å­ï¼‰
- `adj_factor`: å¤æƒå› å­æ•°æ®ï¼ˆä¿ç•™ï¼Œä½†å·²åŒ…å«åœ¨daily_klineä¸­ï¼‰
- `basic_info`: è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
- `trade_calendar`: äº¤æ˜“æ—¥å†

**æ€§èƒ½ä¼˜åŠ¿**ï¼š
- **æ‰¹é‡å†™å…¥**ï¼šå•æ¬¡äº‹åŠ¡å†™å…¥æ‰€æœ‰æ•°æ®ï¼Œæ€§èƒ½æå‡5-15å€
- **è‡ªåŠ¨å»é‡**ï¼šä½¿ç”¨ `INSERT ... ON DUPLICATE KEY UPDATE` è‡ªåŠ¨å¤„ç†é‡å¤æ•°æ®
- **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
- **è¿æ¥æ± ç®¡ç†**ï¼šä½¿ç”¨ SQLAlchemy è¿æ¥æ± ï¼Œæå‡å¹¶å‘æ€§èƒ½

**MySQLBaseStorage** - å­˜å‚¨åŸºç±»
- æä¾›ç»Ÿä¸€çš„æ•°æ®åº“è¿æ¥ç®¡ç†
- å®ç° `_bulk_upsert_dataframe`ï¼Œæ”¯æŒæ‰¹é‡UPSERTæ“ä½œ
- è‡ªåŠ¨å¤„ç†NaNå€¼è½¬æ¢

#### 4. Managerå±‚ (`src/manager.py`)

**Manager** - ç»Ÿä¸€æ•°æ®ç®¡ç†å™¨

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ•°æ®ç±»å‹ï¼ˆæ—¥çº¿ã€å¤æƒå› å­ã€åŸºç¡€ä¿¡æ¯ã€æ—¥å†ï¼‰
- ç»´æŠ¤çº¿ç¨‹æ± ï¼š
  - `io_executor`: 20ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œç”¨äºå¯†é›†æ–‡ä»¶IOæ“ä½œ
  - `task_executor`: 1ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œç”¨äºåå°ä»»åŠ¡è°ƒåº¦

**æ™ºèƒ½æ›´æ–°ç­–ç•¥**ï¼š

1. **å…¨é‡æ›´æ–°ï¼ˆæŒ‰è‚¡ç¥¨ä»£ç ï¼‰** - `_update_all_stocks_full()`
   - é€‚ç”¨åœºæ™¯ï¼šé¦–æ¬¡çˆ¬å–æ•°æ®
   - æµç¨‹ï¼šéå†æ‰€æœ‰è‚¡ç¥¨ â†’ è·å–æœ€è¿‘ä¸€å¹´æ•°æ® â†’ è¦†ç›–å†™å…¥
   - ä¼˜åŠ¿ï¼šæ•°æ®å®Œæ•´ï¼Œé€‚åˆåˆå§‹åŒ–

2. **å¢é‡æ›´æ–°ï¼ˆæŒ‰äº¤æ˜“æ—¥ï¼‰** - `_update_missing_data_incremental()`
   - é€‚ç”¨åœºæ™¯ï¼šå®šæœŸæ›´æ–°æ•°æ®
   - æµç¨‹ï¼š
     - ç”Ÿæˆæ•°æ®å­˜åœ¨æ€§çŸ©é˜µï¼ˆäº¤æ˜“æ—¥ Ã— è‚¡ç¥¨ä»£ç ï¼‰
     - è¯†åˆ«ç¼ºå¤±æ•°æ®è¾ƒå¤šçš„äº¤æ˜“æ—¥ï¼ˆé˜ˆå€¼ï¼š1000åªè‚¡ç¥¨ï¼‰
     - æ‰¹é‡è·å–è¯¥æ—¥æ‰€æœ‰è‚¡ç¥¨æ•°æ®
     - æ‰¹é‡å†™å…¥æ•°æ®åº“
   - ä¼˜åŠ¿ï¼šåªæ›´æ–°ç¼ºå¤±æ•°æ®ï¼Œæ•ˆç‡é«˜

### 2.3 é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ providers/          # APIæ¥å£å±‚
â”‚   â”‚   â”œâ”€â”€ base_provider.py
â”‚   â”‚   â””â”€â”€ tushare_provider.py
â”‚   â”œâ”€â”€ fetch/             # æ•°æ®è·å–å±‚
â”‚   â”‚   â”œâ”€â”€ daily_kline/
â”‚   â”‚   â”œâ”€â”€ basic_info/
â”‚   â”‚   â”œâ”€â”€ calendar/
â”‚   â”‚   â””â”€â”€ adj_factor/
â”‚   â”œâ”€â”€ storage/            # æ•°æ®å­˜å‚¨å±‚
â”‚   â”‚   â”œâ”€â”€ mysql_base.py
â”‚   â”‚   â”œâ”€â”€ daily_kline_storage_mysql.py
â”‚   â”‚   â”œâ”€â”€ adj_factor_storage_mysql.py
â”‚   â”‚   â”œâ”€â”€ basic_info_storage_mysql.py
â”‚   â”‚   â”œâ”€â”€ calendar_storage_mysql.py
â”‚   â”‚   â””â”€â”€ orm_models.py   # å‘åå…¼å®¹å±‚ï¼ˆå·²è¿ç§»åˆ° core/models/orm.pyï¼‰
â”‚   â”œâ”€â”€ manager.py          # ç»Ÿä¸€ç®¡ç†å±‚
â”‚   â””â”€â”€ strategy/           # ç­–ç•¥æ¨¡å—
â”‚
â”œâ”€â”€ core/                   # ETL Pipeline æ¶æ„ï¼ˆæ ¸å¿ƒæ¶æ„ï¼‰
â”‚   â”œâ”€â”€ collectors/         # æ•°æ®é‡‡é›†å±‚ âœ…
â”‚   â”œâ”€â”€ transformers/       # æ•°æ®è½¬æ¢å±‚ âœ…
â”‚   â”œâ”€â”€ loaders/            # æ•°æ®åŠ è½½å±‚ âœ…
â”‚   â”œâ”€â”€ pipelines/          # æµæ°´çº¿ç¼–æ’å±‚ â³
â”‚   â”œâ”€â”€ models/             # æ•°æ®æ¨¡å‹ âœ…
â”‚   â”œâ”€â”€ orchestrator/       # è°ƒåº¦ç¼–æ’å±‚ â³
â”‚   â”œâ”€â”€ config/             # é…ç½®ç®¡ç† ğŸ“‹
â”‚   â””â”€â”€ common/             # å…¬å…±ç»„ä»¶ â³
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ run_fetch.py        # æ•°æ®çˆ¬å–è„šæœ¬
â”‚   â”œâ”€â”€ init_sqlite_db.py   # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚   â””â”€â”€ view_sqlite_data.py # æ•°æ®æŸ¥çœ‹è„šæœ¬
â”‚
â””â”€â”€ data/
    â””â”€â”€ stock_data.db       # SQLiteæ•°æ®åº“æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
```

---

## ä¸‰ã€ç¯å¢ƒå‡†å¤‡

### 3.1 å®‰è£…ä¾èµ–

```bash
uv install
```

### 3.2 é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# Tushare APIå¯†é’¥
TUSHARE_TOKEN=your_tushare_token_here

# MySQL é…ç½®ï¼ˆç”¨äº ETL Pipeline æ¶æ„ï¼‰
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=stock_data
MYSQL_CHARSET=utf8mb4

# æ•°æ®å­˜å‚¨è·¯å¾„ï¼ˆå¯é€‰ï¼‰
DATA_PATH=data/
```

### 3.3 åˆå§‹åŒ–æ•°æ®åº“

```bash
# åˆå§‹åŒ– MySQL æ•°æ®åº“è¡¨ï¼ˆETL Pipeline æ¶æ„ï¼‰
# è¡¨ç»“æ„ä¼šè‡ªåŠ¨åˆ›å»ºï¼ˆé€šè¿‡ ORM æ¨¡å‹ï¼‰

# æˆ–åˆå§‹åŒ– SQLite æ•°æ®åº“ï¼ˆä¼ ç»Ÿæ¶æ„ï¼‰
uv run scripts/init_sqlite_db.py
```

---

## å››ã€æŠ€æœ¯æ ˆ

- **Python 3.8+**
- **Tushare Pro API**: è‚¡ç¥¨æ•°æ®æº
- **MySQL**: æ•°æ®å­˜å‚¨ï¼ˆETL Pipeline æ¶æ„ï¼‰
- **SQLite**: æ•°æ®å­˜å‚¨ï¼ˆä¼ ç»Ÿæ¶æ„ï¼Œå¯é€‰ï¼‰
- **SQLAlchemy**: ORM æ¡†æ¶
- **Pandas**: æ•°æ®å¤„ç†
- **Loguru**: æ—¥å¿—ç®¡ç†
- **uv**: Python åŒ…ç®¡ç†å·¥å…·

---

## äº”ã€å…³é”®ç‰¹æ€§

### ETL Pipeline æ¶æ„ç‰¹æ€§

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šCollectorã€Transformerã€Loader ä¸‰å±‚ç‹¬ç«‹ï¼Œæ˜“äºæ‰©å±•
2. **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡ YAML é…ç½®æ–‡ä»¶æ§åˆ¶æ•°æ®å¤„ç†æµç¨‹
3. **å¤šç§åŠ è½½ç­–ç•¥**ï¼šæ”¯æŒ appendã€replaceã€upsert ä¸‰ç§æ•°æ®åŠ è½½æ–¹å¼
4. **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒæ‰¹é‡æ•°æ®åŠ è½½ï¼Œæå‡æ€§èƒ½
5. **æ•°æ®éªŒè¯**ï¼šåŠ è½½å‰è‡ªåŠ¨éªŒè¯æ•°æ®å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
6. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•

### ä¼ ç»Ÿæ¶æ„ç‰¹æ€§

1. **æ™ºèƒ½æ›´æ–°ç­–ç•¥**ï¼šè‡ªåŠ¨é€‰æ‹©å…¨é‡æ›´æ–°æˆ–å¢é‡æ›´æ–°
2. **é«˜æ€§èƒ½å­˜å‚¨**ï¼šMySQL æ‰¹é‡å†™å…¥ï¼Œæ€§èƒ½æå‡5-15å€
3. **APIä¼˜åŒ–**ï¼šä½¿ç”¨ pro_bar APIï¼Œä¸€æ¬¡è·å–å…¨éƒ¨å†å²æ•°æ®
4. **å¤æƒå› å­é›†æˆ**ï¼šå¤æƒå› å­å·²åŒ…å«åœ¨æ—¥çº¿æ•°æ®ä¸­ï¼Œæ— éœ€å•ç‹¬çˆ¬å–
5. **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨é”æœºåˆ¶ç¡®ä¿APIè°ƒç”¨ä¸²è¡Œï¼Œé¿å…IPè¶…é™

---

## å…­ã€ä½¿ç”¨æ–¹å¼

### ETL Pipeline æ¶æ„ä½¿ç”¨

```python
from core.collectors.daily_kline import DailyKlineCollector
from core.transformers.daily_kline import DailyKlineTransformer
from core.loaders.daily_kline import DailyKlineLoader

# é…ç½®
config = {
    "collector": {
        "source": "tushare",
        "token": "your_token"
    },
    "transformer": {
        "transform_rules": {
            "remove_halted": True,
            "validate_ohlc": True
        }
    },
    "loader": {
        "table": "daily_kline",
        "load_strategy": "upsert",
        "upsert_keys": ["ts_code", "trade_date"],
        "batch_size": 1000
    }
}

# åˆ›å»ºç»„ä»¶
collector = DailyKlineCollector(config["collector"])
transformer = DailyKlineTransformer(config["transformer"])
loader = DailyKlineLoader(config["loader"])

# æ‰§è¡Œ ETL
params = {"ts_code": "000001.SZ", "start_date": "20240101", "end_date": "20241231"}
raw_data = collector.collect(params)
clean_data = transformer.transform(raw_data)
loader.load(clean_data)
```

### ä¼ ç»Ÿæ¶æ„ä½¿ç”¨

```bash
# å…¨é‡æ›´æ–°ï¼ˆæŒ‰è‚¡ç¥¨ä»£ç ï¼Œé¦–æ¬¡çˆ¬å–ï¼‰
uv run scripts/run_fetch.py --mode code --lookback-days 365

# å¢é‡æ›´æ–°ï¼ˆæŒ‰äº¤æ˜“æ—¥ï¼Œå®šæœŸæ›´æ–°ï¼Œé»˜è®¤ï¼‰
uv run scripts/run_fetch.py --mode date --lookback-days 365
```

---

## ä¸ƒã€æ³¨æ„äº‹é¡¹

1. **APIé™åˆ¶**ï¼šTushare APIæœ‰è°ƒç”¨é¢‘ç‡é™åˆ¶ï¼Œç³»ç»Ÿå·²é€šè¿‡ä¸²è¡Œè°ƒç”¨é¿å…è¶…é™
2. **æ•°æ®å®Œæ•´æ€§**ï¼šé¦–æ¬¡çˆ¬å–å»ºè®®ä½¿ç”¨å…¨é‡æ›´æ–°
3. **å®šæœŸæ›´æ–°**ï¼šå»ºè®®æ¯æ—¥ä½¿ç”¨å¢é‡æ›´æ–°
4. **æ•°æ®åº“å¤‡ä»½**ï¼šå»ºè®®å®šæœŸå¤‡ä»½æ•°æ®åº“
5. **æ¶æ„é€‰æ‹©**ï¼š
   - æ–°é¡¹ç›®æ¨èä½¿ç”¨ **ETL Pipeline æ¶æ„**ï¼ˆ`core/`ï¼‰ï¼Œæ›´æ ‡å‡†åŒ–ã€æ˜“ç»´æŠ¤
   - ä¼ ç»Ÿæ¶æ„ï¼ˆ`src/`ï¼‰ä¿ç•™ç”¨äºå…¼å®¹å’Œå¿«é€Ÿæ•°æ®è·å–

---

## å…«ã€æ¶æ„è®¾è®¡å†³ç­–

### 8.1 å‰å¤æƒè®¡ç®—çš„æ¶æ„è®¾è®¡

#### é—®é¢˜èƒŒæ™¯

å‰å¤æƒè®¡ç®—éœ€è¦ä¾èµ–ä¸¤ä¸ªæ•°æ®æºï¼š
- æ—¥Kçº¿æ•°æ®ï¼ˆæ¥è‡ª `DailyKlineCollector`ï¼‰
- å¤æƒå› å­æ•°æ®ï¼ˆæ¥è‡ª `AdjFactorCollector`ï¼‰

å¦‚æœæ”¾åœ¨ Transformer å±‚ï¼Œä¼šå¯¼è‡´ï¼š
- Transformer ä¾èµ–å…¶ä»– Collector/Loaderï¼ˆè¿åå•ä¸€èŒè´£åŸåˆ™ï¼‰
- è·¨å±‚ä¾èµ–ï¼ˆTransformer ä¸åº”è¯¥çŸ¥é“æ•°æ®æ¥æºï¼‰
- éš¾ä»¥æµ‹è¯•ï¼ˆéœ€è¦ mock å¤šä¸ªä¾èµ–ï¼‰

#### è§£å†³æ–¹æ¡ˆï¼šPipeline å±‚åè°ƒ + ç‹¬ç«‹è®¡ç®—å™¨æ¨¡å—

**æ¶æ„è®¾è®¡**ï¼š

```
Pipeline å±‚ï¼ˆç¼–æ’ï¼‰ï¼š
  â”œâ”€ åè°ƒå¤šä¸ª Collector
  â”‚   â”œâ”€ DailyKlineCollector.collect() -> æ—¥Kçº¿æ•°æ®
  â”‚   â””â”€ AdjFactorCollector.collect() -> å¤æƒå› å­æ•°æ®
  â”œâ”€ ä¼ é€’æ•°æ®ç»™ Calculator
  â””â”€ ç®¡ç†æ•°æ®æµ

Calculator å±‚ï¼ˆè®¡ç®—ï¼‰ï¼š
  â”œâ”€ QFQCalculator.calculate(kline_df, adj_factor_df)
  â”œâ”€ æ¥æ”¶æ‰€éœ€æ•°æ®ï¼ˆé€šè¿‡å‚æ•°ä¼ å…¥ï¼Œæ— éšè—ä¾èµ–ï¼‰
  â””â”€ å¯é€‰ï¼šä» Loader è¯»å–è¾…åŠ©æ•°æ®ï¼ˆåŒå±‚ä¾èµ–ï¼Œå¯æ¥å—ï¼‰

Transformer å±‚ï¼ˆè½¬æ¢ï¼‰ï¼š
  â””â”€ åªè´Ÿè´£æ•°æ®æ¸…æ´—å’Œæ ‡å‡†åŒ–ï¼Œä¸æ¶‰åŠå¤æ‚è®¡ç®—
```

**ä¾èµ–å…³ç³»**ï¼š

```
Pipeline
  â”œâ”€> DailyKlineCollector
  â”œâ”€> AdjFactorCollector
  â”œâ”€> QFQCalculator (æ¥æ”¶ä¸¤ä¸ª Collector çš„æ•°æ®)
  â”œâ”€> DailyKlineTransformer (åªæ¥æ”¶æ—¥Kçº¿æ•°æ®)
  â””â”€> DailyKlineLoader

QFQCalculator
  â”œâ”€ æ¥æ”¶å‚æ•°ï¼škline_df, adj_factor_df
  â””â”€ [å¯é€‰] ä¾èµ– Loader è¯»å–å¤æƒå› å­ï¼ˆåŒå±‚ä¾èµ–ï¼Œå¯æ¥å—ï¼‰
```

**è®¾è®¡åŸåˆ™**ï¼š

1. **å•ä¸€èŒè´£**ï¼šæ¯å±‚åªåšè‡ªå·±çš„äº‹
   - Pipelineï¼šè´Ÿè´£ç¼–æ’å’Œåè°ƒ
   - Calculatorï¼šè´Ÿè´£è®¡ç®—é€»è¾‘
   - Transformerï¼šè´Ÿè´£æ•°æ®æ¸…æ´—

2. **ä¾èµ–å€’ç½®**ï¼šä¾èµ–æŠ½è±¡ï¼ˆDataFrameï¼‰ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
   - Calculator æ¥æ”¶ DataFrame å‚æ•°ï¼Œä¸ç›´æ¥è°ƒç”¨ Collector

3. **å¼€é—­åŸåˆ™**ï¼šæ˜“äºæ‰©å±•ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
   - æ–°å¢è®¡ç®—å™¨åªéœ€å®ç°æ¥å£ï¼Œæ— éœ€ä¿®æ”¹ Pipeline

**å®ç°ç¤ºä¾‹**ï¼š

```python
# Pipeline å±‚åè°ƒ
class DailyPipeline(BasePipeline):
    def run(self, stock_codes: List[str], **kwargs):
        # 1. è·å–æ—¥Kçº¿æ•°æ®
        kline_data = self.kline_collector.collect(params)
        
        # 2. è·å–å¤æƒå› å­æ•°æ®
        adj_factor_data = self.adj_factor_collector.collect(params)
        
        # 3. æ•°æ®æ¸…æ´—
        clean_data = self.transformer.transform(kline_data)
        
        # 4. è®¡ç®—å‰å¤æƒï¼ˆå¯é€‰ï¼‰
        if self.config.get("calculate_qfq", False):
            qfq_calculator = QFQCalculator()
            clean_data = qfq_calculator.calculate(clean_data, adj_factor_data)
        
        # 5. å…¥åº“
        self.loader.load(clean_data)
```

### 8.2 åˆ†æ—¶è‚¡ä»·æ•°æ®çš„æ¶æ„è®¾è®¡

#### æ•°æ®ç‰¹ç‚¹

åˆ†æ—¶è‚¡ä»·æ•°æ®å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- **æ•°æ®é‡å¤§**ï¼šä¸€å¤©å¯èƒ½æœ‰å‡ ç™¾æ¡è®°å½•ï¼ˆæ¯åˆ†é’Ÿæˆ–æ¯5åˆ†é’Ÿä¸€æ¡ï¼‰
- **å®æ—¶æ€§è¦æ±‚é«˜**ï¼šéœ€è¦åŠæ—¶æ›´æ–°å½“æ—¥æ•°æ®
- **éœ€è¦ä¸æ—¥Kçº¿ç»“åˆ**ï¼šå¯èƒ½ç”¨äºè¡¥å……æˆ–éªŒè¯å½“æ—¥Kçº¿æ•°æ®
- **æ—¶é—´åºåˆ—ç‰¹æ€§**ï¼šæŒ‰æ—¶é—´é¡ºåºå­˜å‚¨ï¼Œéœ€è¦é«˜æ•ˆçš„æ—¶é—´èŒƒå›´æŸ¥è¯¢

#### æ¶æ„è®¾è®¡

**æ–¹æ¡ˆï¼šç‹¬ç«‹çš„åˆ†æ—¶æ•°æ®æ¨¡å— + èšåˆè®¡ç®—å™¨**

```
core/
â”œâ”€â”€ collectors/
â”‚   â””â”€â”€ intraday_kline.py    # âœ¨ åˆ†æ—¶æ•°æ®é‡‡é›†å™¨
â”‚
â”œâ”€â”€ transformers/
â”‚   â””â”€â”€ intraday_kline.py    # âœ¨ åˆ†æ—¶æ•°æ®è½¬æ¢å™¨
â”‚
â”œâ”€â”€ loaders/
â”‚   â””â”€â”€ intraday_kline.py    # âœ¨ åˆ†æ—¶æ•°æ®åŠ è½½å™¨
â”‚
â”œâ”€â”€ calculators/
â”‚   â”œâ”€â”€ qfq_calculator.py    # å‰å¤æƒè®¡ç®—å™¨
â”‚   â””â”€â”€ aggregator.py        # âœ¨ èšåˆè®¡ç®—å™¨ï¼ˆåˆ†æ—¶ -> æ—¥Kçº¿ï¼‰
â”‚
â”œâ”€â”€ models/
â”‚   â””â”€â”€ intraday_kline.py    # âœ¨ åˆ†æ—¶æ•°æ®æ¨¡å‹
â”‚
â””â”€â”€ pipelines/
    â”œâ”€â”€ daily_pipeline.py    # æ—¥Kçº¿æµæ°´çº¿
    â””â”€â”€ intraday_pipeline.py # âœ¨ åˆ†æ—¶æ•°æ®æµæ°´çº¿
```

**æ•°æ®æµç¨‹**ï¼š

```
1. åˆ†æ—¶æ•°æ®é‡‡é›†
   IntradayKlineCollector.collect()
   â†“
2. åˆ†æ—¶æ•°æ®è½¬æ¢
   IntradayKlineTransformer.transform()
   â†“
3. åˆ†æ—¶æ•°æ®å…¥åº“
   IntradayKlineLoader.load()
   â†“
4. [å¯é€‰] èšåˆä¸ºæ—¥Kçº¿
   Aggregator.aggregate_to_daily()
   â†“
5. ä¸å†å²æ—¥Kçº¿åˆå¹¶/éªŒè¯
   DailyKlineLoader.load()
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **ç‹¬ç«‹å­˜å‚¨**ï¼šåˆ†æ—¶æ•°æ®å•ç‹¬å­˜å‚¨ï¼Œä¸æ··å…¥æ—¥Kçº¿è¡¨
   - è¡¨åï¼š`intraday_kline`
   - ä¸»é”®ï¼š`(ts_code, trade_date, time)` æˆ– `(ts_code, datetime)`
   - ç´¢å¼•ï¼š`ts_code`, `trade_date`, `datetime`

2. **èšåˆè®¡ç®—å™¨**ï¼šå°†åˆ†æ—¶æ•°æ®èšåˆä¸ºæ—¥Kçº¿
   - å¼€ç›˜ä»·ï¼šå½“æ—¥ç¬¬ä¸€ç¬”äº¤æ˜“ä»·æ ¼
   - æ”¶ç›˜ä»·ï¼šå½“æ—¥æœ€åä¸€ç¬”äº¤æ˜“ä»·æ ¼
   - æœ€é«˜ä»·ï¼šå½“æ—¥æ‰€æœ‰åˆ†æ—¶æ•°æ®çš„æœ€é«˜ä»·
   - æœ€ä½ä»·ï¼šå½“æ—¥æ‰€æœ‰åˆ†æ—¶æ•°æ®çš„æœ€ä½ä»·
   - æˆäº¤é‡ï¼šå½“æ—¥æ‰€æœ‰åˆ†æ—¶æ•°æ®çš„æˆäº¤é‡ä¹‹å’Œ

3. **æ•°æ®ç»“åˆç­–ç•¥**ï¼š
   - **æ–¹æ¡ˆA**ï¼šåˆ†æ—¶æ•°æ®ä½œä¸ºæ—¥Kçº¿çš„è¡¥å……
     - å¦‚æœæ—¥Kçº¿æ•°æ®ç¼ºå¤±ï¼Œä»åˆ†æ—¶æ•°æ®èšåˆç”Ÿæˆ
     - å¦‚æœæ—¥Kçº¿æ•°æ®å­˜åœ¨ï¼Œç”¨äºéªŒè¯å’Œä¿®æ­£
   
   - **æ–¹æ¡ˆB**ï¼šåˆ†æ—¶æ•°æ®ç‹¬ç«‹ä½¿ç”¨
     - åˆ†æ—¶æ•°æ®ç”¨äºå®æ—¶åˆ†æå’Œç­–ç•¥
     - æ—¥Kçº¿æ•°æ®ç”¨äºå†å²å›æµ‹å’Œåˆ†æ
     - ä¸¤è€…äº’ä¸å¹²æ‰°

4. **å®æ—¶æ›´æ–°ç­–ç•¥**ï¼š
   - **å¢é‡æ›´æ–°**ï¼šåªæ›´æ–°å½“æ—¥çš„åˆ†æ—¶æ•°æ®
   - **å®šæ—¶æ›´æ–°**ï¼šäº¤æ˜“æ—¶é—´å†…å®šæœŸæ›´æ–°ï¼ˆå¦‚æ¯5åˆ†é’Ÿï¼‰
   - **æ”¶ç›˜åèšåˆ**ï¼šæ”¶ç›˜åå°†å½“æ—¥åˆ†æ—¶æ•°æ®èšåˆä¸ºæ—¥Kçº¿

**å®ç°ç¤ºä¾‹**ï¼š

```python
# åˆ†æ—¶æ•°æ®æ¨¡å‹
class IntradayKline:
    ts_code: str
    trade_date: str  # YYYY-MM-DD
    time: str        # HH:MM:SS
    datetime: datetime  # å®Œæ•´æ—¶é—´æˆ³
    price: float     # ä»·æ ¼
    volume: int      # æˆäº¤é‡
    amount: float    # æˆäº¤é¢

# èšåˆè®¡ç®—å™¨
class Aggregator:
    def aggregate_to_daily(self, intraday_df: pd.DataFrame) -> pd.DataFrame:
        """å°†åˆ†æ—¶æ•°æ®èšåˆä¸ºæ—¥Kçº¿"""
        # æŒ‰æ—¥æœŸåˆ†ç»„
        daily_data = intraday_df.groupby(['ts_code', 'trade_date']).agg({
            'price': ['first', 'last', 'max', 'min'],  # å¼€ã€æ”¶ã€é«˜ã€ä½
            'volume': 'sum',
            'amount': 'sum'
        })
        # ... å¤„ç†é€»è¾‘
        return daily_df

# åˆ†æ—¶æ•°æ®æµæ°´çº¿
class IntradayPipeline(BasePipeline):
    def run(self, stock_codes: List[str], trade_date: str):
        # 1. é‡‡é›†åˆ†æ—¶æ•°æ®
        intraday_data = self.collector.collect(stock_codes, trade_date)
        
        # 2. è½¬æ¢
        clean_data = self.transformer.transform(intraday_data)
        
        # 3. å…¥åº“
        self.loader.load(clean_data)
        
        # 4. [å¯é€‰] èšåˆä¸ºæ—¥Kçº¿
        if self.config.get("aggregate_to_daily", False):
            aggregator = Aggregator()
            daily_data = aggregator.aggregate_to_daily(clean_data)
            # æ›´æ–°æ—¥Kçº¿æ•°æ®
            self.daily_loader.load(daily_data)
```

**ä¸æ—¥Kçº¿ç»“åˆä½¿ç”¨**ï¼š

```python
# åœ¨æ—¥Kçº¿ Pipeline ä¸­ä½¿ç”¨åˆ†æ—¶æ•°æ®
class DailyPipeline(BasePipeline):
    def run(self, stock_codes: List[str], trade_date: str):
        # 1. å°è¯•ä»æ—¥Kçº¿è·å–æ•°æ®
        daily_data = self._load_daily_kline(stock_codes, trade_date)
        
        # 2. å¦‚æœæ—¥Kçº¿æ•°æ®ç¼ºå¤±ï¼Œä»åˆ†æ—¶æ•°æ®èšåˆ
        missing_codes = self._find_missing_codes(daily_data, stock_codes)
        if missing_codes:
            intraday_data = self._load_intraday_kline(missing_codes, trade_date)
            aggregated_data = self.aggregator.aggregate_to_daily(intraday_data)
            daily_data = pd.concat([daily_data, aggregated_data])
        
        # 3. ç»§ç»­åç»­å¤„ç†
        clean_data = self.transformer.transform(daily_data)
        self.loader.load(clean_data)
```

**å­˜å‚¨ä¼˜åŒ–**ï¼š

1. **åˆ†åŒºå­˜å‚¨**ï¼šæŒ‰æ—¥æœŸåˆ†åŒºï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
2. **æ•°æ®ä¿ç•™ç­–ç•¥**ï¼šåªä¿ç•™æœ€è¿‘Nå¤©çš„åˆ†æ—¶æ•°æ®ï¼Œå†å²æ•°æ®å¯å½’æ¡£
3. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•ï¼ˆts_code, trade_date, datetimeï¼‰

---

## ä¹ã€é¡¹ç›®è¿›åº¦æ€»ç»“

### æ€»ä½“è¿›åº¦ï¼šçº¦ 85%

- âœ… **æ•°æ®é‡‡é›†å±‚ï¼ˆCollectorsï¼‰** - 100%
  - æ”¯æŒ Tushare å’Œ Akshare æ•°æ®æº
  - åŒ…å«åˆ†æ—¶æ•°æ®é‡‡é›†å™¨
- âœ… **æ•°æ®è½¬æ¢å±‚ï¼ˆTransformersï¼‰** - 100%
  - åŒ…å«åˆ†æ—¶æ•°æ®è½¬æ¢å™¨ï¼ˆæ”¯æŒ akshare æ•°æ®æ ¼å¼æ ‡å‡†åŒ–ï¼‰
- âœ… **æ•°æ®åŠ è½½å±‚ï¼ˆLoadersï¼‰** - 100%
  - åŒ…å«åˆ†æ—¶æ•°æ®åŠ è½½å™¨
- âœ… **æ•°æ®æ¨¡å‹ï¼ˆModelsï¼‰** - 100%
  - åŒ…å«åˆ†æ—¶æ•°æ®ä¸šåŠ¡æ¨¡å‹å’Œ ORM æ¨¡å‹
- âœ… **è®¡ç®—å™¨æ¨¡å—ï¼ˆCalculatorsï¼‰** - 100% âœ…
  - å‰å¤æƒè®¡ç®—å™¨ï¼ˆQFQCalculatorï¼‰
  - èšåˆè®¡ç®—å™¨ï¼ˆAggregatorï¼‰
- âœ… **åˆ†æ—¶æ•°æ®æ¨¡å—ï¼ˆIntradayï¼‰** - 100% âœ…
  - åˆ†æ—¶æ•°æ®é‡‡é›†ã€è½¬æ¢ã€åŠ è½½å®Œæ•´å®ç°
- â³ **æµæ°´çº¿ç¼–æ’å±‚ï¼ˆPipelinesï¼‰** - 0%ï¼ˆæ¡†æ¶å·²æ­å»ºï¼‰
- â³ **è°ƒåº¦ç¼–æ’å±‚ï¼ˆOrchestratorï¼‰** - 0%ï¼ˆæ¡†æ¶å·²æ­å»ºï¼‰
- â³ **é…ç½®ç®¡ç†** - 0%ï¼ˆç¤ºä¾‹æ–‡ä»¶å·²æä¾›ï¼‰
- â³ **å…¬å…±ç»„ä»¶ï¼ˆéƒ¨åˆ†ï¼‰** - 50%ï¼ˆå¼‚å¸¸å®šä¹‰å·²å®Œæˆï¼‰

### ä¸‹ä¸€æ­¥è®¡åˆ’

1. å®ç° Pipelines å±‚çš„å…·ä½“ ETL æµç¨‹ç¼–æ’
   - å®ç°åˆ†æ—¶æ•°æ®æµæ°´çº¿
   - å®ç°æ—¥Kçº¿æµæ°´çº¿ï¼ˆé›†æˆå‰å¤æƒè®¡ç®—ï¼‰
2. å®ç° Orchestrator å±‚çš„ä»»åŠ¡è°ƒåº¦å’Œä¾èµ–ç®¡ç†
3. å®Œå–„é…ç½®ç®¡ç†ç³»ç»Ÿ
4. å®ç°å…¬å…±å·¥å…·å‡½æ•°
5. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

## ä¹ã€è®¸å¯è¯

MIT License

## åã€å…è´£å£°æ˜

æœ¬é¡¹ç›®ä»…ç”¨äºå­¦ä¹ å’Œç ”ç©¶ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚è‚¡ç¥¨æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚
