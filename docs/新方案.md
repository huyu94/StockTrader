股票复权数据存储与计算设计方案
一、核心设计背景
目标是搭建本地股票策略分析系统，需每日遍历全市场股票、基于股价分析策略选股，并支持手动复盘。核心诉求为：
精准存储股票未复权原始行情数据；
合理维护复权因子，消除除权除息导致的股价跳空；
高效计算 / 存储前复权价格，满足高频选股与复盘需求；
保证数据一致性，降低日常维护成本。
二、核心设计思路
2.1 数据分层逻辑
将数据分为「原始基础数据」和「派生计算数据」两类，优先保证原始数据准确性，派生数据按需计算 / 存储：
原始基础数据：未复权股价（开 / 高 / 低 / 收 / 成交量）、复权因子（仅除权日更新），是系统的核心数据源，需完整存储且永不篡改；
派生计算数据：前复权价格（基于未复权股价 + 复权因子计算），为提升查询效率，选择增量存储而非纯实时计算。
2.2 复权因子核心规则
复权因子仅在股票「除权除息日」更新，非除权日复用前一日因子，避免数据冗余；
历史复权因子永不回溯修改，仅新增除权日的新因子段（分段固定）；
复权因子优先选择「后复权因子」存储（稳定性高），前复权价格通过公式实时计算 / 增量存储。
2.3 前复权价格计算规则
前复权价格核心公式（保证股价趋势连续无跳空）：
plaintext
前复权价(历史日期T) = 未复权价(T) × 最新复权因子 / 历史复权因子(T)
最新复权因子：该股票截至当前的最新有效复权因子；
历史复权因子 (T)：日期 T 对应的有效复权因子（≤T 的最新因子）。
2.4 存储策略选择
放弃「纯按需计算前复权价」，选择「增量存储前复权价」，核心原因：
高频场景（每日全市场选股、手动复盘）对查询效率要求高，纯计算需等待 3-5 分钟，存储后查表仅需秒级；
存储成本极低（全市场年新增数据仅几十 MB），远低于时间成本；
仅增量更新（每日更新当日数据、除权日重算单只股票历史数据），控制维护成本。
三、数据库表结构设计
3.1 核心表：股票行情总表（t_stock_price）
整合未复权股价、前复权股价、成交量等所有核心数据，避免跨表关联开销，字段设计如下：
字段名	数据类型	精度 / 长度	主键标识	字段说明	必要性
stock_code	VARCHAR	10	联合主键	股票代码（含市场标识，如 600519.SH）	必选
trade_date	DATE	-	联合主键	交易日期（YYYY-MM-DD）	必选
open_original	DECIMAL(10,2)	10 位 / 2 位	否	未复权开盘价（元）	必选
high_original	DECIMAL(10,2)	10 位 / 2 位	否	未复权最高价（元）	必选
low_original	DECIMAL(10,2)	10 位 / 2 位	否	未复权最低价（元）	必选
close_original	DECIMAL(10,2)	10 位 / 2 位	否	未复权收盘价（元）	必选
volume	BIGINT	-	否	成交量（股）	必选
turnover	DECIMAL(15,2)	15 位 / 2 位	否	成交额（元）	可选
close_forward	DECIMAL(10,2)	10 位 / 2 位	否	前复权收盘价（核心派生字段）	必选
open_forward	DECIMAL(10,2)	10 位 / 2 位	否	前复权开盘价	可选
high_forward	DECIMAL(10,2)	10 位 / 2 位	否	前复权最高价	可选
low_forward	DECIMAL(10,2)	10 位 / 2 位	否	前复权最低价	可选
is_suspended	TINYINT(1)	-	否	是否停牌（0 = 交易，1 = 停牌）	可选
update_time	DATETIME	-	否	数据更新时间（排查异常用）	必选
字段设计说明：
价格字段选用DECIMAL(10,2)：精准存储 A 股股价（最小单位为分），避免浮点数精度丢失，且字节占用仅 5 字节，存储成本极低；
前复权开 / 高 / 低价为可选：90% 的选股策略仅依赖前复权收盘价，省略可降低计算 / 存储成本，后期可按需补充；
联合主键(stock_code, trade_date)：避免重复数据，保证单股票单日期数据唯一性。
3.2 辅助表：复权因子表（t_stock_adj_factor）
仅存储除权日的复权因子，非除权日复用前一日因子，字段设计如下：
字段名	数据类型	精度 / 长度	主键标识	字段说明	必要性
stock_code	VARCHAR	10	联合主键	股票代码（与行情表一致）	必选
adj_date	DATE	-	联合主键	复权因子生效日期（除权除息日）	必选
adj_factor	DECIMAL(10,4)	10 位 / 4 位	否	后复权因子（保留 4 位小数保证计算精度）	必选
adj_event	VARCHAR	50	否	除权事件说明（如 “10 送 5 派 1 元”）	可选
update_time	DATETIME	-	否	数据入库时间	必选
四、数据更新架构
4.1 每日更新流程（盘后执行）
更新原始行情数据：爬取全市场股票当日未复权股价（开 / 高 / 低 / 收 / 成交量），插入 / 更新至t_stock_price表；
更新复权因子：爬取当日除权除息股票列表，仅对这些股票更新t_stock_adj_factor表的复权因子；
增量更新前复权价：
遍历全市场股票，计算当日的前复权收盘价（及可选的开 / 高 / 低价），更新至t_stock_price表；
对当日除权的股票，重新计算其上市至今的所有历史前复权价，批量更新至t_stock_price表；
数据校验：随机抽查部分股票的前复权价，验证计算结果与实时计算的一致性。
4.2 关键优化点
非除权日仅更新当日前复权价，不触碰历史数据；
除权日仅重算该股票的历史前复权价，不影响其他股票；
所有更新操作按 “先原始数据、后派生数据” 的顺序执行，保证数据一致性。
五、核心设计原则总结
原始数据优先：未复权股价、复权因子作为原始数据，需完整存储、永不篡改，是派生数据的计算基础；
效率优先于存储：为高频选股 / 复盘场景增量存储前复权价，以极小的存储成本换取极致的查询效率；
增量更新替代全量重算：仅更新当日数据和除权股票的历史数据，控制每日维护耗时；
单表整合数据：将未复权价、前复权价、成交量整合至单表，避免跨表关联，简化代码与查询逻辑。
