# 通达信指标公式解析文档

## 指标概述

本文档解析了通达信中的"知行"系列指标，包括短期趋势线、多空线等。这些指标主要用于判断股票的趋势和买卖时机。

---

## 指标列表

### 1. 知行短期趋势线

**公式：**
```
EMA(EMA(C,10),10)
```

**说明：**
- 双重指数移动平均线（Double EMA）
- 先对收盘价（C）计算 10 日 EMA
- 再对第一步的结果计算 10 日 EMA
- 用于捕捉短期趋势变化

**计算方法：**
1. 第一步：计算收盘价的 10 日 EMA
   ```
   EMA1 = EMA(CLOSE, 10)
   ```
2. 第二步：对 EMA1 再次计算 10 日 EMA
   ```
   知行短期趋势线 = EMA(EMA1, 10)
   ```

**特点：**
- 双重平滑，对价格变化更敏感
- 适合捕捉短期趋势转折点
- 颜色：白色（COLORFFFFFF）
- 线宽：1（LINETHICK1）

**Python 实现：**
```python
def calculate_short_trend_line(df: pd.DataFrame) -> pd.Series:
    """
    计算知行短期趋势线
    
    :param df: 包含 close 列的 DataFrame
    :return: 短期趋势线序列
    """
    # 第一步：计算收盘价的 10 日 EMA
    ema1 = df['close'].ewm(span=10, adjust=False).mean()
    
    # 第二步：对 EMA1 再次计算 10 日 EMA
    short_trend = ema1.ewm(span=10, adjust=False).mean()
    
    return short_trend
```

---

### 2. MA1（60日指数移动平均线）

**公式：**
```
EMA(CLOSE, 60)
```

**说明：**
- 收盘价的 60 日指数移动平均线
- 用于判断中长期趋势
- 通常作为趋势参考线

**计算方法：**
```
MA1 = EMA(CLOSE, 60)
```

**Python 实现：**
```python
def calculate_ma1(df: pd.DataFrame) -> pd.Series:
    """计算 60 日 EMA"""
    return df['close'].ewm(span=60, adjust=False).mean()
```

---

### 3. MA2（13日指数移动平均线）

**公式：**
```
EMA(CLOSE, 13)
```

**说明：**
- 收盘价的 13 日指数移动平均线
- 注意：公式中使用 `:=` 表示赋值，不直接显示在图表上
- 可能用于其他指标的计算

**计算方法：**
```
MA2 = EMA(CLOSE, 13)
```

**Python 实现：**
```python
def calculate_ma2(df: pd.DataFrame) -> pd.Series:
    """计算 13 日 EMA"""
    return df['close'].ewm(span=13, adjust=False).mean()
```

---

### 4. 板块信息显示（Z1-Z3）

**公式：**
```
Z1:=STRCAT(HYBLOCK,' ');
Z2:=STRCAT(Z1,DYBLOCK);
Z3:=STRCAT(Z2,' ');
DRAWTEXT_FIX(ISLASTBAR,0,0,0,STRCAT(Z3,GNBLOCK)),COLOR00C0C0;
```

**说明：**
- 用于在图表上显示板块信息
- 拼接行业板块（HYBLOCK）、地域板块（DYBLOCK）、概念板块（GNBLOCK）
- 只在最后一根 K 线上显示（ISLASTBAR）

**字符串拼接逻辑：**
1. Z1 = 行业板块 + 空格
2. Z2 = Z1 + 地域板块
3. Z3 = Z2 + 空格
4. 最终显示 = Z3 + 概念板块

**显示位置：**
- 固定在图表左上角（0,0,0）
- 颜色：青色（COLOR00C0C0）

**注意：**
- 这是通达信特有的显示功能
- Python 实现中通常不需要这部分，除非需要导出图表

---

### 5. 知行多空线

**公式：**
```
(MA(CLOSE,M1)+MA(CLOSE,M2)+MA(CLOSE,M3)+MA(CLOSE,M4))/4
```

**说明：**
- 四个移动平均线的算术平均值
- M1、M2、M3、M4 是参数（需要在指标参数中设置）
- 用于判断多空力量对比

**计算方法：**
```
MA1 = MA(CLOSE, M1)
MA2 = MA(CLOSE, M2)
MA3 = MA(CLOSE, M3)
MA4 = MA(CLOSE, M4)

知行多空线 = (MA1 + MA2 + MA3 + MA4) / 4
```

**参数说明：**
- M1、M2、M3、M4 需要根据实际情况设置
- 常见设置可能是：3、6、12、24 或 5、10、20、60 等
- 类似 BBI 指标（多空指标）的计算方式

**Python 实现：**
```python
def calculate_bull_bear_line(
    df: pd.DataFrame, 
    m1: int = 3, 
    m2: int = 6, 
    m3: int = 12, 
    m4: int = 24
) -> pd.Series:
    """
    计算知行多空线
    
    :param df: 包含 close 列的 DataFrame
    :param m1: 第一个均线周期，默认 3
    :param m2: 第二个均线周期，默认 6
    :param m3: 第三个均线周期，默认 12
    :param m4: 第四个均线周期，默认 24
    :return: 多空线序列
    """
    ma1 = df['close'].rolling(window=m1).mean()
    ma2 = df['close'].rolling(window=m2).mean()
    ma3 = df['close'].rolling(window=m3).mean()
    ma4 = df['close'].rolling(window=m4).mean()
    
    bull_bear_line = (ma1 + ma2 + ma3 + ma4) / 4
    
    return bull_bear_line
```

---

## 指标使用建议

### 1. 知行短期趋势线（白线）
- **买入信号**：价格上穿短期趋势线
- **卖出信号**：价格下穿短期趋势线
- **趋势判断**：趋势线向上表示短期趋势向好

### 2. MA1（60日EMA）（黄线）
- **长期趋势**：价格在 MA1 上方表示长期趋势向上
- **支撑/阻力**：可作为重要的支撑或阻力位

### 3. 知行多空线（紫线）
- **多空判断**：价格在多空线上方表示多头占优
- **买卖信号**：价格上穿/下穿多空线可作为买卖参考
- **参数调整**：根据股票特性调整 M1-M4 参数

---

## 完整 Python 实现示例

```python
import pandas as pd
import numpy as np

def calculate_tongdaxin_indicators(
    df: pd.DataFrame,
    m1: int = 3,
    m2: int = 6,
    m3: int = 12,
    m4: int = 24
) -> pd.DataFrame:
    """
    计算通达信"知行"系列指标
    
    :param df: 包含 close 列的 DataFrame
    :param m1: 多空线参数 M1，默认 3
    :param m2: 多空线参数 M2，默认 6
    :param m3: 多空线参数 M3，默认 12
    :param m4: 多空线参数 M4，默认 24
    :return: 添加了指标列的 DataFrame
    """
    df_result = df.copy()
    
    # 1. 知行短期趋势线（双重 EMA）
    ema1 = df_result['close'].ewm(span=10, adjust=False).mean()
    df_result['short_trend_line'] = ema1.ewm(span=10, adjust=False).mean()
    
    # 2. MA1（60日 EMA）
    df_result['ma1'] = df_result['close'].ewm(span=60, adjust=False).mean()
    
    # 3. MA2（13日 EMA）
    df_result['ma2'] = df_result['close'].ewm(span=13, adjust=False).mean()
    
    # 4. 知行多空线
    ma_m1 = df_result['close'].rolling(window=m1).mean()
    ma_m2 = df_result['close'].rolling(window=m2).mean()
    ma_m3 = df_result['close'].rolling(window=m3).mean()
    ma_m4 = df_result['close'].rolling(window=m4).mean()
    df_result['bull_bear_line'] = (ma_m1 + ma_m2 + ma_m3 + ma_m4) / 4
    
    return df_result
```

---

## 注意事项

1. **EMA vs MA**：
   - 公式中 `EMA` 是指数移动平均（Exponential Moving Average）
   - 公式中 `MA` 是简单移动平均（Simple Moving Average）
   - 注意区分使用

2. **参数设置**：
   - 知行多空线的 M1-M4 参数需要根据实际情况调整
   - 建议先使用默认值测试，再根据效果调整

3. **数据要求**：
   - 计算这些指标需要足够的历史数据
   - 短期趋势线至少需要 20 个交易日
   - MA1 至少需要 60 个交易日
   - 多空线至少需要 max(M1, M2, M3, M4) 个交易日

4. **性能考虑**：
   - EMA 计算使用 `ewm()` 方法，性能较好
   - 批量计算时建议使用向量化操作

---

## 后续实现建议

1. 在 `IndicatorCalculator` 类中添加这些指标的计算方法
2. 创建对应的策略类，使用这些指标进行买卖判断
3. 根据实际效果调整参数（特别是多空线的 M1-M4）
4. 可以结合其他技术指标（如 KDJ、MACD）进行综合判断

